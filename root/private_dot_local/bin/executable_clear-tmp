#!/usr/bin/env bash

FOLDER_TO_CLEAN=""
FILES_TO_KEEP="3"
WATCH=false

print_help() {
cat <<EOF
Usage:

-f|--folder:	Specify which folder to watch (required)
-k|--keep:	Specify how many files to keep (default 3)
-w|--watch:	Whether the folder should be continuously watched (default false)
EOF
}

if [[ $# -eq 0 ]]; then
  print_help
  exit 1
fi

while [[ $# -gt 0 ]]; do
  case $1 in
    -f|--folder)
      FOLDER_TO_CLEAN="$2"
      shift # past argument
      shift # past value
      ;;
    -k|--keep)
      FILES_TO_KEEP="$2"
      shift # past argument
      shift # past value
      ;;
    -w|--watch)
      WATCH=true
      shift # past argument
      ;;
    --help)
      print_help
      exit 0
      ;;
    -*|--*)
      echo "Unknown option $1"
      print_help
      exit 1
      ;;
    *)
      print_help
      exit 1
      ;;
  esac
done

if [[ -z $FOLDER_TO_CLEAN ]]; then
  echo "Required arg -f|--folder not passed"
  print_help
  exit 1
fi

if [[ ! -d "$FOLDER_TO_CLEAN" ]]; then
  echo "Error: Folder does not exist: $FOLDER_TO_CLEAN"
  exit 1
fi

count_files() {
  find "$FOLDER_TO_CLEAN" -maxdepth 1 -type f | wc -l
}

cleanup() {
  local count
  count=$(count_files)

  while [[ $count -gt $FILES_TO_KEEP ]]; do 
      local oldest_file
      oldest_file=$(find "$FOLDER_TO_CLEAN" -maxdepth 1 -type f -printf '%T@ %p\n' \
                    | sort -n | head -n 1 | cut -d' ' -f2-)
      echo "Removing: $oldest_file"
      rm -- "$oldest_file"
      count=$(count_files)
  done
}

if "$WATCH"; then
  echo "Watching $FOLDER_TO_CLEAN (keeping $FILES_TO_KEEP newest files)"
  while true; do
    cleanup
    sleep 1
  done
else
  echo "Removing all but the newest ${FILES_TO_KEEP} files form ${FOLDER_TO_CLEAN}"
  cleanup
fi
